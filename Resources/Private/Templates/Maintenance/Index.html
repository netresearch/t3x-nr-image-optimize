<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
      xmlns:be="http://typo3.org/ns/TYPO3/CMS/Backend/ViewHelpers"
      xmlns:core="http://typo3.org/ns/TYPO3/CMS/Core/ViewHelpers"
      data-namespace-typo3-fluid="true">

<f:layout name="Module"/>

<f:section name="Content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1">Processed Images Maintenance - EXT:nr_image_optimize</h1>
            <p class="text-muted mb-0">Manage on-demand processed images generated by EXT:nr_image_optimize</p>
        </div>
        <div>
            <f:link.action action="systemRequirements" class="btn btn-primary">
                <core:icon identifier="actions-system-extension-configure" size="small"/>
                System Requirements
            </f:link.action>
        </div>
    </div>

    <f:flashMessages as="flashMessages">
        <f:for each="{flashMessages}" as="flashMessage">
            <div class="alert alert-{f:if(condition: '{flashMessage.severity} == 2', then: 'danger', else: 'success')} alert-dismissible fade show" role="alert">
                <core:icon identifier="actions-{f:if(condition: '{flashMessage.severity} == 2', then: 'close', else: 'check')}" size="small"/>
                {flashMessage.message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
        </f:for>
    </f:flashMessages>

    <!-- Summary Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1 small">Total Files</p>
                            <h3 class="mb-0">{fileCount}</h3>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-2 rounded">
                            <core:icon identifier="apps-filetree-folder-media" size="default"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1 small">Total Size</p>
                            <h3 class="mb-0">{totalSizeHuman}</h3>
                        </div>
                        <div class="bg-info bg-opacity-10 p-2 rounded">
                            <core:icon identifier="actions-database" size="default"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-1 small">Subdirectories</p>
                            <h3 class="mb-0">{directoryCount}</h3>
                        </div>
                        <div class="bg-success bg-opacity-10 p-2 rounded">
                            <core:icon identifier="apps-filetree-folder-default" size="default"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column -->
        <div class="col-lg-6">
            <!-- Storage Path -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h2 class="card-title mb-0 h5">
                        <strong>Storage Information</strong>
                    </h2>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label text-muted small mb-1">Directory Path</label>
                        <div class="input-group">
                            <span class="input-group-text"><core:icon identifier="apps-filetree-folder-default" size="small"/></span>
                            <input type="text" class="form-control form-control-sm" value="{processedPath}" readonly>
                        </div>
                    </div>
                    
                    <f:if condition="{oldestFile}">
                        <f:then>
                            <div class="mb-2">
                                <label class="form-label text-muted small mb-1">Oldest File</label>
                                <p class="mb-0 small text-break"><strong>{oldestFile.name}</strong></p>
                                <p class="text-muted small mb-0">{oldestFile.date}</p>
                            </div>
                            <div>
                                <label class="form-label text-muted small mb-1">Newest File</label>
                                <p class="mb-0 small text-break"><strong>{newestFile.name}</strong></p>
                                <p class="text-muted small mb-0">{newestFile.date}</p>
                            </div>
                        </f:then>
                        <f:else>
                            <div class="text-center text-muted py-3">
                                <core:icon identifier="actions-document-info" size="default"/>
                                <p class="mb-0 mt-2">No files in directory</p>
                            </div>
                        </f:else>
                    </f:if>
                </div>
            </div>

            <!-- File Types -->
            <div class="card">
                <div class="card-header bg-light">
                    <h2 class="card-title mb-0 h5">
                        <strong>File Types Distribution</strong>
                    </h2>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">Type</th>
                                    <th class="text-end">Count</th>
                                    <th class="text-end pe-3">Size</th>
                                </tr>
                            </thead>
                            <tbody>
                                <f:if condition="{fileTypes}">
                                    <f:then>
                                        <f:for each="{fileTypes}" key="ext" as="typeData">
                                            <tr>
                                                <td class="ps-3">
                                                    <code class="bg-light px-2 py-1 rounded">.{ext}</code>
                                                </td>
                                                <td class="text-end">{typeData.count}</td>
                                                <td class="text-end pe-3"><strong>{typeData.sizeHuman}</strong></td>
                                            </tr>
                                        </f:for>
                                    </f:then>
                                    <f:else>
                                        <tr>
                                            <td colspan="3" class="text-center text-muted py-3">No files available</td>
                                        </tr>
                                    </f:else>
                                </f:if>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-6">
            <!-- Largest Files -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h2 class="card-title mb-0 h5">
                        <strong>Largest Files (Top 5)</strong>
                    </h2>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">File Path</th>
                                    <th class="text-end pe-3">Size</th>
                                </tr>
                            </thead>
                            <tbody>
                                <f:if condition="{largestFiles}">
                                    <f:then>
                                        <f:for each="{largestFiles}" as="file">
                                            <tr>
                                                <td class="ps-3">
                                                    <span class="text-break small">{file.path}</span>
                                                </td>
                                                <td class="text-end pe-3 text-nowrap"><strong>{file.sizeHuman}</strong></td>
                                            </tr>
                                        </f:for>
                                    </f:then>
                                    <f:else>
                                        <tr>
                                            <td colspan="2" class="text-center text-muted py-3">No files available</td>
                                        </tr>
                                    </f:else>
                                </f:if>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Clear Action -->
            <div class="card border-warning">
                <div class="card-header bg-warning bg-opacity-10">
                    <h2 class="card-title mb-0 h5">
                        <core:icon identifier="actions-delete" size="small"/>
                        <strong>Clear Processed Images</strong>
                    </h2>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-3">
                        <div class="d-flex">
                            <div style="margin-right: 0.5rem;">
                                <core:icon identifier="actions-exclamation-triangle" size="small"/>
                            </div>
                            <div class="small">
                                <strong>Notice:</strong> After clearing, all processed images will be regenerated on-demand when first accessed. This may temporarily increase loading times on the frontend.
                            </div>
                        </div>
                    </div>
                    
                    <f:form action="clearProcessedImages">
                        <div class="d-grid">
                            <f:form.button type="submit" class="btn btn-danger">
                                <core:icon identifier="actions-delete" size="small"/>
                                Clear All Processed Images
                            </f:form.button>
                        </div>
                    </f:form>
                </div>
            </div>
        </div>
    </div>
</f:section>

</html>
